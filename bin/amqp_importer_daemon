#!/usr/bin/env ruby
require 'rubygems'
require 'daemons'

script_dir = File.dirname(__FILE__)

script = File.expand_path(script_dir + '/../vendor/plugins/logjam/script/import_amqp_log')

capistrano_install = File.exist?(script_dir + '/../../shared') && File.exist?(script_dir + '/../../current')

pid_file_dir = File.expand_path(capistrano_install ? "#{script_dir}/../../shared/pids" : "#{script_dir}/../tmp/pids")

command, controller_options, application_array = Daemons::Controller.split_argv(ARGV)

OptionParser.new do |opts|
  opts.banner = "Usage: amqp_import_daemon #{command} [options] application"
  opts.separator ""

  opts.on("--pid-dir DIR", String, "Write pid and log to DIR") do |val|
    pid_file_dir = val
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
end.parse!

application = application_array[0]
puts "amqp log importer daemon #{command} #{application}"

daemon_options = {:dir_mode => :normal, :dir => pid_file_dir, :backtrace => true, :log_output => true, :multiple => false}

if application.nil?
  Daemons.run(script,  daemon_options.merge(:ARGV => [command]))
else
  Daemons.run(script, daemon_options.merge(:app_name => "import_amqp_log_#{application}", :ARGV => [command, '--', application]))
end
